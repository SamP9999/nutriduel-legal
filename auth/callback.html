<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Confirmed - NutriDuel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #22AE6B 0%, #1a8a54 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 24px;
      background: #22AE6B;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 12px;
    }
    
    p {
      font-size: 16px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 32px;
    }
    
    .button {
      display: inline-block;
      background: #22AE6B;
      color: white;
      padding: 16px 32px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      border: none;
      width: 100%;
      transition: background 0.2s;
    }
    
    .button:hover {
      background: #1a8a54;
    }
    
    .button:active {
      transform: scale(0.98);
    }
    
    .fallback {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e0e0e0;
    }
    
    .fallback p {
      font-size: 14px;
      color: #999;
      margin-bottom: 12px;
    }
    
    .fallback a {
      color: #22AE6B;
      text-decoration: none;
      font-weight: 500;
    }
    
    .fallback a:hover {
      text-decoration: underline;
    }
    
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">âœ“</div>
    <h1>Email Confirmed</h1>
    <p>Your email has been verified. Continue in the NutriDuel app to complete your account setup.</p>
    
    <div id="error-message" style="display: none;" class="error"></div>
    
    <button id="open-app-button" class="button" onclick="openApp()">
      Open NutriDuel
    </button>
    
    <div class="fallback">
      <p>If the app didn't open automatically:</p>
      <a href="#" id="app-store-link" onclick="openAppStore(event)">
        Install NutriDuel from the App Store
      </a>
    </div>
  </div>

  <script>
    // Extract parameters from both query string and hash fragment
    // Supabase may redirect with tokens in hash fragment (#access_token=...) or query params (?code=...)
    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1)); // Remove the '#' from hash
    
    // Try query params first, then hash fragment
    const code = urlParams.get('code') || hashParams.get('code');
    const tokenHash = urlParams.get('token_hash') || hashParams.get('token_hash');
    const type = urlParams.get('type') || hashParams.get('type');
    const error = urlParams.get('error') || hashParams.get('error');
    const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
    
    // Also check for hash fragment tokens (OAuth implicit flow)
    const accessToken = hashParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token');
    const expiresAt = hashParams.get('expires_at');

    // Build deep link URL with all params
    function buildDeepLink() {
      const params = new URLSearchParams();
      
      // Prefer code/token_hash flow (authorization code)
      if (code) params.set('code', code);
      if (tokenHash) params.set('token_hash', tokenHash);
      
      // If we have hash fragment tokens, pass them to app
      // The app can use these directly to establish session
      if (accessToken) params.set('access_token', accessToken);
      if (refreshToken) params.set('refresh_token', refreshToken);
      if (expiresAt) params.set('expires_at', expiresAt);
      
      if (type) params.set('type', type);
      if (error) params.set('error', error);
      if (errorDescription) params.set('error_description', errorDescription);
      
      const queryString = params.toString();
      return `nutriduel://auth/callback${queryString ? '?' + queryString : ''}`;
    }

    // Open the app via deep link
    function openApp() {
      const deepLink = buildDeepLink();
      
      // Log for debugging (remove in production if needed)
      console.log('[Callback Bridge] Opening app with deep link:', deepLink);
      
      // Attempt to open the app
      window.location.href = deepLink;
      
      // Fallback: If app doesn't open within 2 seconds, show App Store link
      setTimeout(() => {
        const appStoreLink = document.getElementById('app-store-link');
        if (appStoreLink) {
          appStoreLink.style.display = 'block';
        }
      }, 2000);
    }

    // Open App Store (placeholder - replace with actual App Store URL)
    function openAppStore(event) {
      event.preventDefault();
      // TODO: Replace with actual App Store URL when available
      const appStoreUrl = 'https://apps.apple.com/app/nutriduel'; // Placeholder
      window.open(appStoreUrl, '_blank');
    }

    // Check for errors in URL
    if (error) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = errorDescription || error || 'An error occurred during email confirmation.';
      errorDiv.style.display = 'block';
    }

    // Auto-attempt to open app on page load (iOS may allow this in some cases)
    // But we still show the button as primary action since user gesture is more reliable
    window.addEventListener('load', () => {
      // Small delay to ensure page is fully loaded
      setTimeout(() => {
        // Only auto-open if we have valid params
        if (code || tokenHash || accessToken) {
          // Try opening, but button is still the primary action
          // Some iOS versions may block auto-redirect, so button is fallback
        }
      }, 500);
    });

    // Handle visibility change (user may have switched to app)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // Page is hidden - user likely switched to app
        console.log('[Callback Bridge] Page hidden - user may have opened app');
      }
    });
  </script>
</body>
</html>

